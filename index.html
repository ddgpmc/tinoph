<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Evacuation Center Finder</title>

<!-- Leaflet CSS -->
<link rel="stylesheet" href="https://unpkg.com/leaflet/dist/leaflet.css" />
<link rel="stylesheet" href="https://unpkg.com/leaflet-routing-machine/dist/leaflet-routing-machine.css" />

<style>
  html, body { margin:0; padding:0; height:100%; }
  #map { height:100%; width:100%; }
  #controls {
    position: absolute;
    top: 10px;
    left: 50%;
    transform: translateX(-50%);
    z-index: 1000;
    background: white;
    padding: 10px;
    border-radius: 8px;
    box-shadow: 0 0 5px rgba(0,0,0,0.3);
  }
  #controls button {
    padding: 10px 15px;
    font-size: 16px;
    border: none;
    border-radius: 5px;
    background-color: #EC1B34;
    color: white;
    cursor: pointer;
  }
</style>
</head>
<body>

<div id="map"></div>

<div id="controls">
  <button id="findNearestBtn">Find the Nearest Evacuation Center</button>
</div>

<script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>
<script src="https://unpkg.com/leaflet-routing-machine/dist/leaflet-routing-machine.js"></script>

<script>
  var map = L.map('map').fitWorld();
  L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', { maxZoom: 19 }).addTo(map);

  var evacCenters = [];
  var userLatLng = null;
  var routeControl = null;

  // Load GeoJSON files automatically (must be in same folder)
  async function loadGeoJSON(url) {
    const res = await fetch(url);
    const geojson = await res.json();
    const centers = geojson.features.map(f => ({
      name: f.properties.name || "Evacuation Center",
      lat: f.geometry.coordinates[1],
      lng: f.geometry.coordinates[0]
    }));

    L.geoJSON(geojson, {
      onEachFeature: function(feature, layer){
        layer.bindPopup(feature.properties.name || "Evacuation Center");
      }
    }).addTo(map);

    return centers;
  }

  async function loadAllCenters() {
    try {
      const cleanedCenters = await loadGeoJSON('ph_evacs_cleaned.geojson');
      const rawCenters = await loadGeoJSON('ph_evacs_raw.geojson');
      evacCenters = cleanedCenters.concat(rawCenters);
      console.log("Evacuation centers loaded: " + evacCenters.length);
    } catch(err){
      alert("Error loading GeoJSON files. Make sure both files are in the same folder.\n" + err);
    }
  }

  loadAllCenters();

  // Detect user location
  map.locate({ setView: true, maxZoom: 16 });
  map.on('locationfound', function(e){
    userLatLng = e.latlng;
    L.marker(userLatLng).addTo(map).bindPopup("You are here").openPopup();
  });
  map.on('locationerror', function(){
    alert("Could not get your location. Please allow location access.");
  });

  // Button click: find nearest center
  document.getElementById('findNearestBtn').addEventListener('click', function(){
    if(!userLatLng){
      alert("Waiting for your location. Please allow location access.");
      return;
    }
    if(evacCenters.length === 0){
      alert("Evacuation centers not loaded yet.");
      return;
    }

    // Find nearest
    let nearest = evacCenters[0];
    let minDist = userLatLng.distanceTo(L.latLng(nearest.lat, nearest.lng));

    evacCenters.forEach(center => {
      let dist = userLatLng.distanceTo(L.latLng(center.lat, center.lng));
      if(dist < minDist){
        minDist = dist;
        nearest = center;
      }
    });

    // Show popup with name/address
    L.popup()
      .setLatLng(userLatLng)
      .setContent("Nearest evacuation center: <b>" + nearest.name + "</b><br>Distance: " + (minDist/1000).toFixed(2) + " km")
      .openOn(map);

    // Draw route
    if(routeControl) map.removeControl(routeControl); // remove previous route
    routeControl = L.Routing.control({
      waypoints: [
        L.latLng(userLatLng.lat, userLatLng.lng),
        L.latLng(nearest.lat, nearest.lng)
      ],
      routeWhileDragging: false,
      draggableWaypoints: false,
      addWaypoints: false
    }).addTo(map);
  });
</script>

</body>
</html>
